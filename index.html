<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 
      IMPORTANTE: Reemplaza 'YOUR_CLIENT_ID' con tu Client ID de PayPal.
      Obtenlo desde tu panel de desarrollador de PayPal.
    -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=MXN"></script>
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiVmlzaW9uIFNob3AgUFdBIiwic2hvcnRfbmFtZSI6IlZpc2lvblNob3AiLCJkZXNjcmlwdGlvbiI6IlVzYSBlc3RhIHRpZW5kYSBvbmxpbmUgY29tbyBBUFAiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHNaV00wYVc5dWN5Qm1aVzVqZEdsdmJrdGxlM1ZpZENBeE1EQWFNREF3TURBd01EQXdNREF3TUNBd01EQXdNREF4TURBd01EQXdNREF3TUNCelpYSjJhV05sUFNKbVptbHNaVDRnTURBeE1EQWFNREF3TURBd01EQXdNREF3TUNBd01EQXdNREF4TURBd01EQXdNREF3TUNCemRISnNaVDRnZEdWemRDSjlMV2xrUFFvPSIsInNpemVzIjoiMTkyeDE5MiIsInRypeciOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7Y2hhcnNldD11dGYtOCxiYXNlNjQsUEhOMlp5QjRiV3hzWldOMGFXOXVjeUJtWlc1amRHbHZiZ3RsZTNWcWRDQXhNREFhTURBd01EQXdNREF3TURBd01EQXdNQ0F3TURBd01EQXhNREF3TURBd01EQXdNQUF3TUNBekxXTjBhVzVsUFNKbVptbHNaVDRnTURBeE1EQWFNREF3TURBd01EQXdNREF3TUNBd01EQXdNREF4TURBd01EQXdNREF3TUNCemRISnNaVDRnZEdWemRDSjlMV2xrUFFvPSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzEzMTgzRSIsImNvbG9yIjoiIzEwQjk4MSJ9">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .product-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #374151; /* gray-700 */
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); /* green-500 glow */
            border-color: #10B981; /* green-500 */
        }
        .form-input {
           background-color: #374151; /* gray-700 */
           border: 1px solid #4B5563; /* gray-600 */
        }
        .form-input:focus {
            outline: none;
            border-color: #10B981; /* green-500 */
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="config-error" class="hidden fixed inset-0 bg-red-900 text-white p-8 flex flex-col justify-center items-center z-[100] text-center">
        <h1 class="text-3xl font-bold mb-4">Error de Configuración Crítico</h1>
        <p class="text-lg">La aplicación no pudo inicializar los servicios de Firebase.</p>
        <p class="mt-2 text-md max-w-2xl">Esto usualmente significa que la configuración de Firebase no se ha proporcionado correctamente. Por favor, pega tu objeto `firebaseConfig` directamente en el archivo `index.html`.</p>
    </div>
    
    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40 border-b border-gray-700">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#home" class="flex items-center space-x-2">
                <!-- Logo SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="140" height="32" viewBox="0 0 140 32" class="h-8 w-auto">
                  <style>
                    .text { font-family: 'Inter', sans-serif; font-size: 24px; font-weight: bold; }
                  </style>
                  <path d="M2 16 C 2 16 8 4 16 4 C 24 4 30 16 30 16 C 30 16 24 28 16 28 C 8 28 2 16 2 16 Z" stroke="#FFFFFF" stroke-width="2.5" fill="none"/>
                  <circle cx="16" cy="16" r="6" fill="#10B981"/>
                  <circle cx="16" cy="16" r="2" fill="#FFFFFF"/>
                  <text x="38" y="24" class="text" fill="#FFFFFF">Vision</text>
                  <text x="100" y="24" class="text" fill="#10B981">Shop</text>
                </svg>
            </a>
            <div id="nav-links" class="flex items-center space-x-4">
                <a href="#home" class="text-gray-300 hover:text-green-400">Tienda</a>
                <a href="#cart" class="text-gray-300 hover:text-green-400">Carrito (<span id="cart-count">0</span>)</a>
                
                <a href="#orders" id="orders-link" class="hidden text-gray-300 hover:text-green-400 font-semibold">Mis Pedidos</a>
                <a href="#vendor-dashboard" id="vendor-link" class="hidden text-gray-300 hover:text-green-400 font-semibold">Panel de Vendedor</a>
                
                <div id="auth-links">
                    <a href="#login" class="text-gray-300 hover:text-green-400">Acceder</a>
                    <a href="#register" class="ml-2 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Registrarse</a>
                </div>
                <div id="user-session" class="hidden items-center">
                    <span id="user-email" class="text-sm text-gray-400 mr-4"></span>
                    <button id="logout-btn" class="bg-red-600 text-white py-2 px-3 rounded-lg hover:bg-red-700 transition-colors">Salir</button>
                </div>
            </div>
        </nav>
    </header>

    <main id="app-root" class="container mx-auto p-6">
        <div id="store-page">
            <h1 class="text-3xl font-bold mb-6 text-white">Nuestros Productos</h1>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                 <div class="col-span-full text-center p-8">Cargando productos...</div>
            </div>
        </div>

        <div id="cart-page" class="hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">Tu Carrito de Compras</h1>
            <div id="cart-items-container" class="bg-gray-800 p-6 rounded-lg border border-gray-700"></div>
            <div id="cart-summary" class="mt-6 bg-gray-800 p-6 rounded-lg border border-gray-700">
                 <h2 class="text-2xl font-semibold text-white">Resumen</h2>
                 <p class="text-lg mt-2">Total: $<span id="cart-total">0.00</span> MXN</p>
                 <div id="paypal-button-container" class="mt-4"></div>
            </div>
        </div>

        <div id="register-page" class="hidden max-w-md mx-auto bg-gray-800 p-8 rounded-lg border border-gray-700">
            <h1 class="text-2xl font-bold mb-6 text-center text-white">Crear una Cuenta</h1>
            <form id="register-form">
                <div class="mb-4">
                    <label for="register-email" class="block text-gray-300 mb-1">Email</label>
                    <input type="email" id="register-email" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block text-gray-300 mb-1">Contraseña</label>
                    <input type="password" id="register-password" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                </div>
                <div class="mb-6">
                    <p class="block text-gray-300 mb-2">Quiero registrarme como:</p>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="role" value="client" class="text-green-500 focus:ring-green-500" checked> <span class="ml-2">Cliente</span></label>
                        <label class="flex items-center"><input type="radio" name="role" value="vendor" class="text-green-500 focus:ring-green-500"> <span class="ml-2">Vendedor</span></label>
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">Crear Cuenta</button>
            </form>
            <p class="text-center mt-4 text-sm">¿Ya tienes cuenta? <a href="#login" class="text-green-400 hover:underline">Inicia sesión</a></p>
        </div>

        <div id="login-page" class="hidden max-w-md mx-auto bg-gray-800 p-8 rounded-lg border border-gray-700">
            <h1 class="text-2xl font-bold mb-6 text-center text-white">Iniciar Sesión</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-300 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-300 mb-1">Contraseña</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">Acceder</button>
            </form>
            <p class="text-center mt-4 text-sm">¿No tienes cuenta? <a href="#register" class="text-green-400 hover:underline">Regístrate aquí</a></p>
        </div>

        <div id="orders-page" class="hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">Mis Pedidos</h1>
            <div id="orders-list-container" class="space-y-6"></div>
        </div>
        
        <div id="vendor-dashboard-page" class="hidden">
            <h1 class="text-3xl font-bold mb-6 text-white">Panel de Vendedor</h1>
            <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-white" id="form-title">Agregar Nuevo Producto</h2>
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="product-name" class="block text-gray-300 mb-1">Nombre</label>
                            <input type="text" id="product-name" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                        </div>
                        <div class="mb-4">
                            <label for="product-price" class="block text-gray-300 mb-1">Precio (MXN)</label>
                            <input type="number" id="product-price" step="0.01" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="product-description" class="block text-gray-300 mb-1">Descripción</label>
                        <textarea id="product-description" rows="3" class="w-full px-3 py-2 rounded-lg form-input text-white" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="product-image" class="block text-gray-300 mb-1">URL de la Imagen</label>
                        <input type="url" id="product-image" class="w-full px-3 py-2 rounded-lg form-input text-white" placeholder="https://ejemplo.com/imagen.jpg" required>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors" id="save-product-btn">Guardar Producto</button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">Cancelar Edición</button>
                    </div>
                </form>
            </div>
            <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 mb-8">
                 <h2 class="text-2xl font-bold mb-4 text-white">Mis Productos</h2>
                 <div id="vendor-product-list" class="space-y-4"></div>
            </div>
            <div class="bg-gray-800 p-8 rounded-lg border border-gray-700">
                 <h2 class="text-2xl font-bold mb-4 text-white">Pedidos Recibidos</h2>
                 <div id="vendor-orders-list-container" class="space-y-6"></div>
            </div>
        </div>
    </main>

    <div id="shipping-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-md border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white">Actualizar Información de Envío</h2>
            <form id="shipping-form">
                <input type="hidden" id="shipping-order-id">
                <div class="mb-4">
                    <label for="shipping-company" class="block text-gray-300 mb-1">Empresa de Paquetería</label>
                    <input type="text" id="shipping-company" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                </div>
                <div class="mb-4">
                    <label for="tracking-number" class="block text-gray-300 mb-1">Número de Rastreo</label>
                    <input type="text" id="tracking-number" class="w-full px-3 py-2 rounded-lg form-input text-white" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-shipping-update" class="bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Guardar y Notificar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, query, where, Timestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- INICIO DE LA LÓGICA DE LA APP ---
        
        let allProducts = [];
        let vendorProducts = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentUser = null;
        let currentUserProfile = null;
        let unsubscribeVendorProducts = null;
        let unsubscribeClientOrders = null;
        let unsubscribeVendorOrders = null;
        
        let pages = {};
        let productList, vendorProductList, cartCount, cartItemsContainer, cartTotal;
        let productForm, registerForm, loginForm, logoutBtn;
        let ordersListContainer, vendorOrdersListContainer, shippingModal, shippingForm;
        let db, auth, appId;

        function navigate(hash) {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            const targetPage = hash.substring(1); 
            
            if (targetPage === 'vendor-dashboard' && (!currentUser || currentUserProfile?.role !== 'vendor')) {
                window.location.hash = '#login';
                return;
            }
            if (targetPage === 'orders' && !currentUser) {
                window.location.hash = '#login';
                return;
            }
            
            const pageToShow = pages[targetPage] || pages.store;
            if(pageToShow) pageToShow.classList.remove('hidden');

            if (targetPage === 'cart') renderCart();
        }
        
        function updateNavUI() {
            const authLinks = document.getElementById('auth-links');
            const userSession = document.getElementById('user-session');
            const vendorLink = document.getElementById('vendor-link');
            const ordersLink = document.getElementById('orders-link');

            if (currentUser && currentUserProfile) {
                authLinks.classList.add('hidden');
                userSession.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUser.email;
                vendorLink.classList.toggle('hidden', currentUserProfile.role !== 'vendor');
                ordersLink.classList.toggle('hidden', currentUserProfile.role !== 'client');
            } else {
                authLinks.classList.remove('hidden');
                userSession.classList.add('hidden');
                vendorLink.classList.add('hidden');
                ordersLink.classList.add('hidden');
            }
        }
        
        function renderAllProducts() {
            productList.innerHTML = allProducts.length === 0 
                ? '<p class="col-span-full text-center">No hay productos disponibles.</p>'
                : allProducts.map(product => `
                    <div class="product-card bg-gray-800 rounded-lg shadow-md overflow-hidden">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https.placehold.co/600x400/1F2937/ffffff?text=Imagen no disponible';">
                        <div class="p-4">
                            <h3 class="text-lg font-bold text-white">${product.name}</h3>
                            <p class="text-gray-400 mt-1 h-20 overflow-hidden">${product.description}</p>
                            <p class="text-xl font-bold mt-2 text-green-400">$${product.price.toFixed(2)} MXN</p>
                            <button data-id="${product.id}" class="add-to-cart-btn mt-4 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">Agregar al Carrito</button>
                        </div>
                    </div>`).join('');
        }
        
        function renderVendorProducts() {
            vendorProductList.innerHTML = vendorProducts.length === 0
                ? '<p>Aún no has agregado ningún producto.</p>'
                : vendorProducts.map(product => `
                    <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg border border-gray-600">
                        <div>
                            <p class="font-semibold text-white">${product.name} - <span class="text-green-400">$${product.price.toFixed(2)}</span></p>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${product.id}" class="edit-btn bg-yellow-500 text-white py-2 px-3 rounded hover:bg-yellow-600 transition-colors">Editar</button>
                            <button data-id="${product.id}" class="delete-btn bg-red-600 text-white py-2 px-3 rounded hover:bg-red-700 transition-colors">Eliminar</button>
                        </div>
                    </div>`).join('');
        }
        
        function renderCart() {
            document.getElementById('cart-summary').classList.toggle('hidden', cart.length === 0);
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Tu carrito está vacío.</p>';
                return;
            }
            
            let total = 0;
            cartItemsContainer.innerHTML = cart.map(item => {
                total += item.price * item.quantity;
                return `
                    <div class="flex justify-between items-center border-b border-gray-700 py-2">
                        <div><p class="font-semibold text-white">${item.name} (x${item.quantity})</p></div>
                        <p class="font-semibold text-green-400">$${(item.price * item.quantity).toFixed(2)}</p>
                    </div>`;
            }).join('');

            cartTotal.textContent = total.toFixed(2);
            renderPayPalButtons(total);
        }

        function renderPayPalButtons(total) {
            const paypalContainer = document.getElementById('paypal-button-container');
            paypalContainer.innerHTML = '';
            if (total <= 0) return;
            paypal.Buttons({
                style: { layout: 'vertical', color: 'silver', shape: 'rect', label: 'paypal' },
                createOrder: (data, actions) => actions.order.create({
                    purchase_units: [{ amount: { value: total.toFixed(2), currency_code: 'MXN' } }]
                }),
                onApprove: (data, actions) => actions.order.capture().then(async details => {
                    showToast(`¡Pago completado por ${details.payer.name.given_name}!`);
                    await createOrderInFirestore();
                    cart = [];
                    saveCart();
                    renderCart();
                    window.location.hash = '#orders';
                }),
                onError: (err) => {
                    console.error('Error de PayPal:', err);
                    showToast('Ocurrió un error con el pago.', 'error');
                }
            }).render('#paypal-button-container');
        }

        async function createOrderInFirestore() {
            if (!currentUser || cart.length === 0) return;
            const vendorIds = [...new Set(cart.map(item => item.vendorId))];
            const orderData = {
                userId: currentUser.uid, userEmail: currentUser.email, items: cart,
                total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                orderDate: Timestamp.now(), status: 'Procesando', vendorIds: vendorIds,
                shippingCompany: '', trackingNumber: ''
            };
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), orderData);
                showToast('Tu pedido ha sido registrado.');
            } catch (error) {
                console.error("Error al crear la orden:", error);
                showToast('Hubo un problema al registrar tu pedido.', 'error');
            }
        }
        
        function renderUserOrders(orders) {
            ordersListContainer.innerHTML = orders.length === 0
                ? '<p class="text-center">Aún no has realizado ningún pedido.</p>'
                : orders.map(order => {
                    const trackingInfo = order.status === 'Enviado' ? `
                        <p class="text-sm text-gray-400 mt-2">Paquetería: <span class="font-semibold text-gray-300">${order.shippingCompany}</span></p>
                        <p class="text-sm text-gray-400">Rastreo: <span class="font-semibold text-green-400">${order.trackingNumber}</span></p>` : '';
                    return `
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-gray-400">Pedido: ${order.id}</p>
                                <span class="text-sm font-semibold px-2 py-1 rounded-full ${order.status === 'Enviado' ? 'bg-blue-500 text-white' : 'bg-yellow-500 text-black'}">${order.status}</span>
                            </div>
                            <p class="text-gray-300 mt-2">Fecha: ${new Date(order.orderDate.seconds * 1000).toLocaleDateString()}</p>
                            <p class="text-lg font-bold text-white mt-1">Total: $${order.total.toFixed(2)} MXN</p>
                            ${trackingInfo}
                        </div>`;
                }).join('');
        }
        
        function renderVendorOrders(orders) {
            vendorOrdersListContainer.innerHTML = orders.length === 0
                ? '<p class="text-center">No has recibido ningún pedido.</p>'
                : orders.map(order => {
                    const updateButton = order.status === 'Procesando' ? `<button data-id="${order.id}" class="update-shipping-btn bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700">Actualizar Envío</button>` : `<p class="text-sm text-green-400">Enviado</p>`;
                    return `
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-gray-300">Pedido para: ${order.userEmail}</p>
                                    <p class="font-bold text-white">Total: $${order.total.toFixed(2)} MXN</p>
                                </div>
                                ${updateButton}
                            </div>
                        </div>`;
                }).join('');
        }
        
        function updateCartCount() {
            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) cartItem.quantity++;
            else cart.push({ ...product, quantity: 1 });
            saveCart();
            showToast(`"${product.name}" fue agregado al carrito.`);
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            if (!currentUser || currentUserProfile?.role !== 'vendor') return showToast('Acción no permitida.', 'error');
            const id = document.getElementById('product-id').value;
            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                description: document.getElementById('product-description').value,
                image: document.getElementById('product-image').value,
                vendorId: currentUser.uid
            };

            try {
                if (id) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/products`, id), productData);
                    showToast('Producto actualizado con éxito.');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/products`), productData);
                    showToast('Producto agregado con éxito.');
                }
                productForm.reset();
                cancelEdit();
            } catch (error) {
                console.error("Error al guardar el producto: ", error);
                showToast('Error al guardar el producto.', 'error');
            }
        }

        function handleEditProduct(id) {
            const product = vendorProducts.find(p => p.id === id);
            if (!product) return;
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-image').value = product.image;
            document.getElementById('form-title').textContent = 'Editando Producto';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        async function handleDeleteProduct(id) {
            if (await showConfirm('¿Estás seguro?')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, id));
                    showToast('Producto eliminado.');
                } catch(error) {
                    console.error("Error al eliminar producto: ", error);
                    showToast('Error al eliminar producto.', 'error');
                }
            }
        }
        
        function cancelEdit() {
            productForm.reset();
            document.getElementById('product-id').value = '';
            document.getElementById('form-title').textContent = 'Agregar Nuevo Producto';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }
        
        async function handleRegistration(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, `artifacts/${appId}/public/data/users`, userCredential.user.uid), {
                    email: userCredential.user.email,
                    role: role
                });
                showToast('¡Cuenta creada exitosamente!');
            } catch (error) {
                const messages = { 'auth/email-already-in-use': 'Este correo ya está en uso.', 'auth/weak-password': 'La contraseña es muy débil.' };
                showToast(messages[error.code] || 'Ocurrió un error al registrar.', 'error');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Inicio de sesión exitoso.');
            } catch (error) {
                showToast('Correo o contraseña incorrectos.', 'error');
            }
        }

        function handleLogout() {
            signOut(auth);
        }
        
        function initializeAppEventListeners() {
            window.addEventListener('hashchange', () => navigate(window.location.hash));
            productList.addEventListener('click', e => {
                if (e.target.classList.contains('add-to-cart-btn')) addToCart(e.target.dataset.id);
            });
            vendorProductList.addEventListener('click', e => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('edit-btn')) handleEditProduct(id);
                if (e.target.classList.contains('delete-btn')) handleDeleteProduct(id);
            });
            productForm.addEventListener('submit', handleProductFormSubmit);
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
            registerForm.addEventListener('submit', handleRegistration);
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            vendorOrdersListContainer.addEventListener('click', e => {
                if (e.target.classList.contains('update-shipping-btn')) {
                    document.getElementById('shipping-order-id').value = e.target.dataset.id;
                    shippingModal.classList.remove('hidden');
                }
            });
            document.getElementById('cancel-shipping-update').addEventListener('click', () => {
                shippingModal.classList.add('hidden');
                shippingForm.reset();
            });
            shippingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const orderId = document.getElementById('shipping-order-id').value;
                const orderRef = doc(db, `artifacts/${appId}/public/data/orders`, orderId);
                try {
                    await updateDoc(orderRef, {
                        status: 'Enviado',
                        shippingCompany: document.getElementById('shipping-company').value,
                        trackingNumber: document.getElementById('tracking-number').value
                    });
                    showToast('Información de envío actualizada.');
                    shippingModal.classList.add('hidden');
                    shippingForm.reset();
                } catch (error) {
                    showToast('Error al actualizar el envío.', 'error');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            pages = {
                store: document.getElementById('store-page'), cart: document.getElementById('cart-page'),
                register: document.getElementById('register-page'), login: document.getElementById('login-page'),
                vendorDashboard: document.getElementById('vendor-dashboard-page'), orders: document.getElementById('orders-page'),
            };
            productList = document.getElementById('product-list');
            vendorProductList = document.getElementById('vendor-product-list');
            cartCount = document.getElementById('cart-count');
            cartItemsContainer = document.getElementById('cart-items-container');
            cartTotal = document.getElementById('cart-total');
            productForm = document.getElementById('product-form');
            registerForm = document.getElementById('register-form');
            loginForm = document.getElementById('login-form');
            logoutBtn = document.getElementById('logout-btn');
            ordersListContainer = document.getElementById('orders-list-container');
            vendorOrdersListContainer = document.getElementById('vendor-orders-list-container');
            shippingModal = document.getElementById('shipping-modal');
            shippingForm = document.getElementById('shipping-form');

            try {
                // ===================================================================
                // Tu configuración de Firebase va aquí. La he insertado por ti.
                // ===================================================================
                const firebaseConfig = {
                  apiKey: "AIzaSyBZTpQS56CaA7jr0uL2hTdVAac7Vvs_E",
                  authDomain: "vision-shop-4e60c.firebaseapp.com",
                  projectId: "vision-shop-4e60c",
                  storageBucket: "vision-shop-4e60c.appspot.com",
                  messagingSenderId: "602810351229",
                  appId: "1:602810351229:web:3d9ea49685bad3a7c7614",
                  measurementId: "G-HQEGKJVSBC"
                };

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIza...")) {
                    throw new Error("Configuración de Firebase no encontrada o es un placeholder. Por favor, pega tu configuración real.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                appId = firebaseConfig.appId;

                initializeAppEventListeners();
                updateCartCount();
                main();
            } catch (error) {
                console.error("Error Crítico de Inicialización:", error.message);
                document.getElementById('config-error').classList.remove('hidden');
                return;
            }
            
            navigate(window.location.hash || '#home');
        });
        
        async function main() {
            onAuthStateChanged(auth, async (user) => {
                if (unsubscribeVendorProducts) unsubscribeVendorProducts();
                if (unsubscribeClientOrders) unsubscribeClientOrders();
                if (unsubscribeVendorOrders) unsubscribeVendorOrders();
                
                if (user && !user.isAnonymous) {
                    currentUser = user;
                    const userDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid));
                    currentUserProfile = userDoc.exists() ? userDoc.data() : null;
                    
                    if (currentUserProfile?.role === 'client') {
                        const q = query(collection(db, `artifacts/${appId}/public/data/orders`), where("userId", "==", user.uid));
                        unsubscribeClientOrders = onSnapshot(q, (snapshot) => renderUserOrders(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));
                    }
                    if (currentUserProfile?.role === 'vendor') {
                        const qp = query(collection(db, `artifacts/${appId}/public/data/products`), where("vendorId", "==", user.uid));
                        unsubscribeVendorProducts = onSnapshot(qp, (snapshot) => renderVendorProducts(vendorProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                        const qo = query(collection(db, `artifacts/${appId}/public/data/orders`), where("vendorIds", "array-contains", user.uid));
                        unsubscribeVendorOrders = onSnapshot(qo, (snapshot) => renderVendorOrders(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));
                    }
                    if (['#login', '#register', ''].includes(window.location.hash)) {
                        window.location.hash = currentUserProfile?.role === 'vendor' ? '#vendor-dashboard' : '#home';
                    }
                } else {
                    currentUser = null; currentUserProfile = null;
                    vendorProducts = []; renderVendorProducts();
                    if (['#vendor-dashboard', '#orders'].includes(window.location.hash)) window.location.hash = '#home';
                }
                updateNavUI();
                navigate(window.location.hash || '#home');
            });

            try {
                 if (!auth.currentUser) {
                    await signInAnonymously(auth);
                 }
            } catch (error) {
                console.error("Fallo el inicio de sesión anónimo:", error);
                productList.innerHTML = '<p class="col-span-full text-center text-red-400">Error de conexión. Intenta recargar la página.</p>';
            }

            onSnapshot(collection(db, `artifacts/${appId}/public/data/products`), (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllProducts();
            }, (error) => {
                console.error("Error al cargar productos públicos:", error);
                productList.innerHTML = '<p class="col-span-full text-center text-red-400">Error al cargar productos. Revisa tus reglas de seguridad.</p>';
            });
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        
        function showConfirm(message) {
            return new Promise(resolve => {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                confirmModal.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center border border-gray-700">
                        <p class="mb-4 text-white">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirm-yes" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Sí</button>
                            <button id="confirm-no" class="bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-500">No</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
                document.getElementById('confirm-yes').onclick = () => { resolve(true); document.body.removeChild(confirmModal); };
                document.getElementById('confirm-no').onclick = () => { resolve(false); document.body.removeChild(confirmModal); };
            });
        }

    </script>
</body>
</html>

